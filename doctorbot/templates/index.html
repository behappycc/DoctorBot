<!doctype html>

<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Seek Doctor</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">
</head>


<body>
    <div class="container" style="margin-top: 5vh;">
        <ul class="list-group" style="height: 80vh;  overflow-y: auto;" id="messages">
        </ul>

        <div class="input-group" >
            <input type="text" style="text-align: right" class="form-control" id="user_input" name="user_input" placeholder="Say something" />
            <span class="input-group-btn"><button class="btn btn-default" id="send_button"><i class="glyphicon glyphicon-send"></i></button></span>
        </div>
    </div>
</body>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
<script>
     $(document).ready(function() {
        var i=0;  //use for data-id 
        $('#send_button').on('click', sendMessage);
        $('#user_input').on('keypress', sendMessage);
        $('#user_input').on('keyup blur', function () {
            if($('#user_input').val().length > 0) {
                $('#send_button').prop('disabled', false); 
            } else {
                $('#send_button').prop('disabled', 'disabled'); 
            }
        });
        $('#messages').on('click','#ms_api_r',function(){
	console.log('button');
        $.ajax({
        url:'/ms_api',
        type:'GET',
        data:{'status':'ok'},
        contentType:'application/json',
        success:function(){console.log('send api')}       
	})
        return false;

      });
        i = i+1;
    });

    'use strict';
    var bot_message = ['<li class="list-group-item" data=0 style="text-align: left">',
    'TEXT',
    '<button id="ms_api_r" class="btn btn-default" style="text-align: right">播放</button>',
    '</li>'];

    var user_message = ['<li class="list-group-item" data=1 style="text-align: right">',
    'TEXT',
    '<button class="btn btn-default" id="ms_api" >播放</button>',
    '</li>'];
    var sendMessage = function (e) {
       if (e.type === 'click' || e.which === 13){
            var user_input = $('#user_input').val();
            var message = user_message.join('\n').replace('TEXT', user_input);
            var post_data = {
                'message' : user_input
            }
            //var ii=i;
            $('#messages').append(message);
            $('#user_input').val('');
            $('#messages').scrollTop($('ul li').last().position().top + $('ul li').last().height());
           function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }   
    });
            $.ajax({
                url:'/query/', 
                type: 'GET',
                data: post_data,
                contentType: 'application/json;charset=utf-8',
                success: function(data) {
                    console.log(post_data)
                   
                    var result = JSON.parse(JSON.stringify(data));
                    if (result.error){
                        console.log(result.error_text);
                    }
                    console.log(result);
                    var text = bot_message.join('\n').replace('TEXT', result);//.replace(0,ii);
                    //text['data'] = '1';
                    $('#messages').append(text);
                    $('#messages').scrollTop($('ul li').last().position().top + $('ul li').last().height());
                   
                }
            });
            return false;
        }
    };

    // using jQuery
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');


</script>

</html>
